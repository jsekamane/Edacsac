<!DOCTYPE html>
<html lang="da">
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="robots" content="noindex, nofollow" />
		<meta name="author" content="Jonas K. Sekamane">
		
		<title>Edacsac</title>
		
		<link rel="stylesheet" href="css/style.css">
		<link rel="stylesheet" href="css/tipsy.css" type="text/css" />
		<link rel='stylesheet' href='css/basic.css' type='text/css' media='screen' />
		<script type="text/javascript" src="js/d3.v3.js"></script>
		<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
		<script type="text/javascript" src="js/jquery.tipsy.js"></script>
		<script type='text/javascript' src='js/jquery.simplemodal.js'></script>
	</head>
	
	<body>
		
		<header>Test project by <a href="http://jonas.sekamane.com">Jonas K. Sekamane</a></header>
		
		<h1>Edacsac <em>Visualizing Discussions</em></h1>

		<input class="large" type="url" value="http://newz.dk/anonymous-tager-afstand-fra-angreb-paa-fagforeningen-3f-s-hjemmeside/page1#postcontaine">
		<button class="large" id="button-1">&rarr;</button>
		
		<p><strong>Newz.dk</strong>: <a href="http://newz.dk/anonymous-tager-afstand-fra-angreb-paa-fagforeningen-3f-s-hjemmeside/page1#postcontainer">Anonymous tager afstand fra angreb på fagforeningen 3F’s hjemmeside</a></p>
		
		<style type='text/css'>
			/* Table */
			#presentation table {
				width: 100%;
				/*display: none;*/
			}
			#presentation table td, #presentation table th  {
				border: 1px solid #eee;
				padding: 4px;
			}
			
			/* x- and y-axis */
			.domain { 
			  fill: none; 
			  stroke: black; 
			  stroke-width; 1; 
			}
			
			/* Network */
			.edge {
				fill: none;
				stroke: #666;
				stroke-width: 1.5px;
				opacity: 0.2;
			}
			path.link.resolved {
			  stroke-dasharray: 0,2 1;
			}
			
		</style>
		
		<script type='text/javascript'>
			var parseDate = d3.time.format("%d. %b. %Y %H:%M").parse;
		
			// http://stackoverflow.com/a/822486/1053612
			function strip(html)
			{
			   var tmp = document.createElement("DIV");
			   tmp.innerHTML = html;
			   return tmp.textContent||tmp.innerText;
			}
		
			// word count
			// http://jsfiddle.net/deepumohanp/jZeKu/
			var regex = /\s+/gi;
			var wordCount = function(value) {
				return value.trim().replace(regex, ' ').split(' ').length;
			}
			var totalChars = function(value) {
				return value.length;
			}
			var charCount = function(value) {
				return value.trim().length;
			}
			var charCountNoSpace = function(value) {
				return value.replace(regex, '').length;
			}
			var lixCount = function(value) {
				var A = wordCount(value);									// Number of words
				var B = value.match(/([.?!:;])/g, '').length;													// Number of periods (defined by period, colon or capital first letter)
				var C = value.replace(/([.,?!-_])/g, '').match(/([^\s]{6,})/g, '').length;	// Number of long words (More than 6 letters)
				//return B;
				return A/B + (C * 100)/A;
			}
			
			// Loading data from multiple sources (currently only 1, therefore remaining = 1)
			var jsonComments, jsonEdges, remaining = 1;
			d3.json("crawler/comments-crawl.json", function(error, json) {
				// Error handling
				if (error) return console.warn(error);
				jsonComments = json;
				if (!--remaining) dataLoaded();
			});
			/*d3.json("crawler/tmplinks.json", function(error, json) {
				// Error handling
				if (error) return console.warn(error);
				jsonEdges = json;
				if (!--remaining) dataLoaded();
			});*/

			function dataLoaded() {
				
				// Setting the date on which the article was published
				articleDate = parseDate(jsonComments.articleDate);
				
				// hours since article date
				var since = function(date) {
					return (date - articleDate) / 1000 / 60 / 60;
				}
				
				// Focusing on the comments
				var comments = jsonComments.comments;

				
				/*****************************
				***** TABLE PRESENTATION *****
				******************************/
				var table = d3.select("#presentation").append("table").attr("class","grid");

				var thead = table.append("thead");
					thead.append("th").text("num");
					thead.append("th").text("page");
					thead.append("th").text("post");
					thead.append("th").text("image");
					thead.append("th").text("user");
					thead.append("th").text("rating");
					thead.append("th").text("date");
					thead.append("th").text("content");
					thead.append("th").text("cites");

				var tr = table.selectAll("tr")
					.data(comments)
					.enter().append("tr");
				
				var td = tr.selectAll("td")
						.data(function(d) { return d3.entries(d); })
						.enter().append("td")
						.text(function(d) {
							// Hiding image url and the comments since they break the layout of the table, because of their length
							return (d.key == "image" || d.key == "contents") ? "#": d.value;
						});
					
				/*
				* return (parseDate(d) - articleDate) / 1000 / 60 / 60; // Hours since article published
				* return wordCount(d);
				* if (d) { return d.split(", ").length; } else { return "0"; } // Number of citations, rather than the list of citings
				*/

			
				/*****************************
				***** TIME LINE          *****
				******************************/
				
				// Custom color scale, where "Neutral" is predefined
				d3.scale.category10custom = function() {
					return d3.scale.ordinal().range(d3_category10custom);
				};
				var d3_category10custom = [ "#888", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf" ];
				var color = d3.scale.category10custom();
				var temp = color("Neutral"); // Just to ensure that "Neutral" is the first, e.g. gray.
				
				
				// Time line: Hours after publication VS lix!
				var margin = {top: 40, right: 15, bottom: 60, left: 60},
				    width = 960 - margin.left - margin.right,
				    height = 500 - margin.top - margin.bottom;

				var x = d3.scale.linear()
					.range([0, width]);

				var y = d3.scale.linear()
				    .range([height, 0]);

				var xAxis = d3.svg.axis()
				    .scale(x)
				    .orient("bottom");

				var yAxis = d3.svg.axis()
				    .scale(y)
				    .orient("left");

				var svg1 = d3.select("#chart-1").append("svg")
				    .attr("width", width + margin.left + margin.right)
				    .attr("height", height + margin.top + margin.bottom)
					.append("g")
					    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
				
				// draw the x axis
				var xAxis = d3.svg.axis()
					.scale(x)
					.orient('bottom');
					
				svg1.append('g')
					.attr("class", "x axis")
					.attr("transform", "translate(0," + height + ")")
					.call(xAxis)
					.append("text")
						.attr("x", "50%")
						.attr("dy", "3.71em")
						.style("text-anchor", "middle")
						.text("Hours after publication of the article");

				// draw the y axis
				var yAxis = d3.svg.axis()
					.scale(y)
					.orient('left');
					
				svg1.append('g')
					.attr("class", "y axis")
					.call(yAxis)
					.append("text")
						.attr("transform", "rotate(-90)")
						.attr("y", 6)
						.attr("dy", "-4.71em")
						.style("text-anchor", "end")
						.text("LIX, indicating the difficulty of reading a text");
				
				x.domain(d3.extent(comments, function(d) { return since(parseDate(d.date)); }));
				y.domain([0, d3.max(comments, function(d) { return lixCount(d.contents); })]);
				
				var comment = svg1.selectAll(".dot")
					.data(comments)
					.enter().append("circle")
					.attr("class", "dot")
					.attr("r", 3.5)
					.attr("cx", function(d) { return x( since(parseDate(d.date)) ); }) // Hours since article published)
					.attr("cy", function(d) { return y( lixCount(d.contents) ); })
					.style("fill", function(d) { return color(d.rating); })
					.on("click", function(d){
						$.modal("<h4>#"+d.num+": "+d.user+"</h4>"+d.contents, {closeHTML: "", overlayClose: true});
					});

				var legend = svg1.selectAll(".legend")
					.data(color.domain())
					.enter().append("g")
					.attr("class", "legend")
					.attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });
				legend.append("rect")
					.attr("x", width - 18)
					.attr("width", 18)
					.attr("height", 18)
					.style("fill", color);
				legend.append("text")
					.attr("x", width - 24)
					.attr("y", 9)
					.attr("dy", ".35em")
					.style("text-anchor", "end")
					.text(function(d) { return d; });
				
				// TOOL TIP
				$('svg .dot').tipsy({ 
				    gravity: 'w',    // gravity
				    html: true,     // is tooltip content HTML?
				    offset: -30,       // pixel offset of tooltip from element
					title: function() {
						var d = this.__data__;
						return "<strong>#"+d.num+"</strong> "+d.user;
					}
				});
			
			
				
				/* Bar chart */
				x.domain([0, 55])
				y.domain([0, d3.max(comments, function(d) { return wordCount(d.contents); })]);
			
				var svg2 = d3.select("#chart-2").append("svg")
				    .attr("width", width + margin.left + margin.right)
				    .attr("height", height + margin.top + margin.bottom)
					.append("g")
					    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
					
				svg2.append("g")
					.attr("class", "x axis")
					.attr("transform", "translate(0," + height + ")")
					.call(xAxis)
					.append("text")
						.attr("x", "50%")
						.attr("dy", "3.71em")
						.style("text-anchor", "middle")
						.text("Hours after publication of the article");
					
				svg2.append("g")
					.attr("class", "y axis")
					.call(yAxis)
					.append("text")
						.attr("transform", "rotate(-90)")
						.attr("y", 6)
						.attr("dy", ".71em")
						.style("text-anchor", "end")
						.text("Word count");
					
				var comment = svg2.selectAll(".bar")
					.data(comments)
					.enter().append("rect")
					.attr("class", "bar")
					.attr("r", 3.5)
					.attr('opacity', .5)
					.attr("y", function(d) { return 0; })
					.attr("x", function(d) { return x( since(parseDate(d.date)) ); }) // Hours since article published)
					.attr("width", 4)
					.attr("y", function(d) { return y(wordCount(d.contents)); })
					.attr("height", function(d) { return (height - y(wordCount(d.contents))); })
					.style("fill", function(d) { return color(d.rating); })
					.on("click", function(d){
						$.modal("<h4>#"+d.num+": "+d.user+"</h4>"+d.contents, {closeHTML: "", overlayClose: true});
					});
				
				var legend = svg2.selectAll(".legend")
					.data(color.domain())
					.enter().append("g")
					.attr("class", "legend")
					.attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });
				legend.append("rect")
					.attr("x", width - 18)
					.attr("width", 18)
					.attr("height", 18)
					.style("fill", color);
				legend.append("text")
					.attr("x", width - 24)
					.attr("y", 9)
					.attr("dy", ".35em")
					.style("text-anchor", "end")
					.text(function(d) { return d; });
					
				// TOOL TIP
				$('svg .bar').tipsy({ 
				    gravity: 'w',    // gravity
				    html: true,     // is tooltip content HTML?
				    offset: -30,       // pixel offset of tooltip from element
					title: function() {
						var d = this.__data__;
						return "<strong>#"+d.num+"</strong> "+d.user;
					}
				});


				
				// Compute the distinct links from the nodes/comments.
				function link(source, target, value) {
					this.source = source;
					this.target = target;
					this.value = value;
				}
				var links = []
				comments.forEach(function(d) {
					n = Math.floor(d.num);
					d.cites.split(", ").forEach(function(d) {
						if(d && d != 0) { // ignore the empty and the comments refering to the article, e.g. #0.
							links.push( new link(n-1, Math.floor(d)-1, 1) ); // Create unweieghted set of links
						}
					});	
				});
				
				
				/* Graph / Network */
				var basicTick = true;
				var force = d3.layout.force()
					.nodes(comments)
					.links(links)
					.size([width, height])
					.linkDistance(30)
					.charge(-70)
					.on("tick", tick)
					.start();

				var svg = d3.select("#chart-3").append("svg:svg")
					.attr("width", width)
					.attr("height", height);

				// Per-type markers, as they don't inherit styles.
				svg.append("svg:defs").selectAll("marker")
					.data(["EndMarker"])
					.enter().append("svg:marker")
						.attr("id", String)
						.attr("viewBox", "0 -5 10 10")
						.attr("refX", 15)
						.attr("refY", -1.5)
						.attr("markerWidth", 5)
						.attr("markerHeight", 5)
						.attr("orient", "auto")
						.append("svg:path")
							.attr("d", "M0,-5L10,0L0,5");

				var edge = svg.append("svg:g").selectAll(".edge")
					.data(force.links())
					.enter().append("svg:path")
						.attr("class", "edge")
						.attr("marker-end", "url(#EndMarker)");

				var node = svg.append("svg:g").selectAll(".node")
					.data(force.nodes())
					.enter().append("svg:circle")
						.attr("class", "node")
						.attr("r", 6)
						.style("fill", function(d) { return color(d.rating); })
						.call(force.drag)
						.on("click", function(d){
							$.modal("<h4>#"+d.num+": "+d.user+"</h4>"+d.contents, {closeHTML: "", overlayClose: true});
						});

				// Use elliptical arc path segments to doubly-encode directionality.
				function tick() {
					//console.log("How often is this called?")
					
					if(basicTick){
						edge.attr("d", function(d) {
							var dx = d.target.x - d.source.x,
							dy = d.target.y - d.source.y,
							dr = Math.sqrt(dx * dx + dy * dy);
							return "M" + d.source.x + "," + d.source.y + "A" + dr + "," + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
						});

						node.attr("transform", function(d) {
							return "translate(" + d.x + "," + d.y + ")";
						});
					} else {
						edge.attr("d", function(d) {
							//var dx = d.target.x - d.source.x,
							var dx = d.target.x - d.source.x,
							dy = d.target.y - d.source.y,
							//dr = Math.sqrt(dx * dx + dy * dy);
							dr = 0;
							return "M" + x( since(parseDate(d.source.date)) ) + "," + y(d.source.cites.split(", ").length*200) + "A" + dr + "," + dr + " 0 0,1 " + x( since(parseDate(d.target.date)) ) + "," + y(d.target.cites.split(", ").length*200);
						});
						
						node.attr("transform", function(d) {
							//return "translate(" + d.x + "," + d.y + ")";
							return "translate(" + x( since(parseDate(d.date)) ) + "," + y(d.cites.split(", ").length*200) + ")";
						});
						force.stop();
					}
				}
				
				// TOOL TIP
				$('svg .node').tipsy({ 
				    gravity: 'w',    // gravity
				    html: true,     // is tooltip content HTML?
				    offset: -30,       // pixel offset of tooltip from element
					title: function() {
						var d = this.__data__;
						return "<strong>#"+d.num+"</strong> "+d.user;
					}
				});
				
				
				d3.select("#btn3-pause").on("click", function() { force.stop(); });
				d3.select("#btn3-continue").on("click", function() { force.resume(); basicTick = true; });
				
				d3.select("#btn3-1").on("click", function() {
					force.stop();
										
					d3.select(node[0][70])
						.transition()
							.duration(750)
							.style("stroke", "red")
					        .style("stroke-opacity", 1e-6)
					        .style("stroke-width", 60)
							.transition()
								.duration(750)
								.style("stroke-opacity", 1)
								.style("stroke-width", 0)
				});

				d3.select("#btn3-2").on("click", function() {
				//	force.stop();

					//console.log(d3.select(node))
					//console.log(d3.selectAll(node[0]));
					//node.transition().duration(500).delay(500).attr("cy", 90);
				/*	d3.selectAll(node[0]).transition().duration(500)
						//.attr("cy", 90)
						.style("stroke", "red")
				        .style("stroke-opacity", 1e-6)
				        .style("stroke-width", 60)
						.transition()
							.duration(0)
							.style("stroke-opacity", 1)
							.style("stroke-width", 0)
				*/
					basicTick = false;
				});
				
				


			}

		</script>
		
		<div class='chart' id='chart-3'></div>
		<button id="btn3-pause">Pause</button>
		<button id="btn3-continue">Continue</button>
		<button id="btn3-1">Surprise me</button>
		<button id="btn3-2">Boom goes the dynamite!</button>
		
		<div class='chart' id='chart-1'></div>
		
		<div class='chart' id='chart-2'></div>
		
		<div class="chart" id="presentation"></div>
		
		<h2><a name="explanation" href="#explanation">#</a>Explanation</h2>
		<p>...</p>
		
		<h2><a name="inspiration" href="#inspiration">#</a>Inspiration</h2>
		<p>This project is inspired by The New York Times Company Research &amp; Development Lab's <a href="http://nytlabs.com/projects/cascade.html">Cascade project</a>.</p>
		
	</body>
</html>